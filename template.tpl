___TERMS_OF_SERVICE___

By creating or modifying this file you agree to Google Tag Manager's Community
Template Gallery Developer Terms of Service available at
https://developers.google.com/tag-manager/gallery-tos (or such other URL as
Google may provide), as modified from time to time.


___INFO___

{
  "type": "TAG",
  "id": "cvt_temp_public_id",
  "version": 1,
  "securityGroups": [],
  "displayName": "AdTiming Tag",
  "brand": {
    "id": "brand_dummy",
    "displayName": "AdTiming",
    "thumbnail": "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAGAAAABgCAYAAADimHc4AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAYdSURBVHgB7dhLTxtXFAfw/x0/4rQBTKI2j6aJIxI1kfpwKkWyTaBjqYtIXSReZI35BJhPAOkXKG0XXQKLStlBKlXqziY04JaqkEU3fYRJ1VZVQY2TlJftuafnjjHBwWBCIFGU85MM2MzcuXPPveceDyCEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCHEXphFNGxe2GMKooYZdD/8GQU1ehxTM9hjfgjPNCLhIA70FKGvAOXUKcw4eAZe+gBkvYH39zxEORPCykwApeRbcAp4Rl7aFDSCcDiEUE8JlHEVteyn4GeX8EcGYu99iUPpr3Bk9msco0m06e9wug/PyUu1Aj5HyD6B8OAbaI60qBD2kb8Q4A33KL4fxnNi4QV2CYgM40jfNM5GtjquH7AHEMiexevZd9QR79gSuY4Fsp/n4BubrgD7YszWGja2UC65oxNTlVLNjsUi2lIZUqplw0WI7kNZ0zdv3Vq72cSFC1F/wHcFDRCpwvjk5IBp37Vgk4bzbT6f6+fB/5P3UJ9SJz/EITSr/cML+uG1FApO9dw0d6sV6DuHZvttvIZXEMADrPBPywkhkOyNt0Y5/4d9wdBoLpcrXIzFbGUhUtLI5fN5Z7M+mb77Ar5otS/V8XI1Io3ux+dThdz45Gj1fd0qqDOR6NOa+tGAP+Dvs2271XReW9YID1eUB7v+wdzbzkS8v6gpaW7O3ACHpmHuVQoO/xowg8+1+SB8aojf5w5iHwev2PKQI/4fivCTL+2qYPoLemXoByzeeAD0tMJvn0czDvPQu9D4Wz0gi6wxF/5UHL8VOqz4oCJll5eXzTVyljIxU11BC04sFktuFoTKxOG+K8qZ87zJp1V2O/lcu2Z8Y9duTuT7vbbqHkWUNmuDQN0myvUOsSyVNb+581HTCT4n7K0nQkYT3d5wvOLBU4gEvUDhvI9nWRmUxNpAqx4ebLMiZjj4vY867NYtCZuwf2gBK6MaxP3wRZoRQhghakYw/ROK6cPcWBuFEOSLFlHGkioRp51Pr2K+F41xP1V2qyCsV5kc5tbN5NBjmx2niDOKUl08Rz+ofrYhAKupJ8J/OuMT+aHNGuPZXPdzM/jVZfmYU7yyps0q6Wxv78pV0pFT/WdHIhbhLl4hosIm59foRqHQ2R7ve//nX1PBOXeEU0pknhbNtKGrOK7maYHmsKDM4PNEwiIVPx5OvEsX9Wl7O+2jEoRpTjfJapptTI9tNWacLUbd4nKO73NtUm0IAC8lLy9zNHPYZVrrXm/lkJvit0+9+XGyi/545oz9D35J0dydkROKTp6mVxVXOjiHw+oYlugO/r1/D4uZ6+3noxwbU+cnGzdMZhY7ZrZyms3yhMms378a4YEOc2qIbvhHeRmV/WXSqX7kr3NXl730o7V3wY54PMur2cYu4Is52lyC0IJdQ9Hf29rCB+bmkvsJ2UNYjjRhCU1qH45S0903cTBlnul08J683ZqbLGt2/NZEN+dqx8v1pId4HFpNMbDNJsxEztb7nPcXM6a91bZqytBEIhE1eZr/dNYt0xscFKfmtUNFy9qzp4vfcJ8XeXbPo+zc55l/j5b4eUIh+TQP1CobJV0zf/Mk/MQUJ9s5zxQlPMuGeaLl1r+4ldW+0OXqsTUrwEcubxJWTfpZjVRN5FdLzlk8IT/pjLkTZfmGsAeucxA4xyTvYaUviMXej/DXUz/TMUHgGVswAeCB6+cg8Ke68XmT+fTjn1X219qVUZuCLOsyKlXkKLbASczZbBOux+REXVrhpYwufusUXXcMe2TA29jdbmD3nqeZSdgRixWUxZUcTHm+swcI5nvC42euBcCb1VTJ9b5gcMcDxJvsCAen5u51ccWkHvMqlEvlVH5qysELZjyfH+KKaMZsyqjcywa8tjlNxbdKUxvOWwtAmcsurlNzStGYl8MaqOS0R3U6KcxstT+Ydq1gaGBiYnJnU5O80s3xvlVX29R0l3862zm93rFPcr5hylFTlnIQBvle+XtPpZw0pScPfJTH5L3ttMPfeW5DCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQgghhBBCCCGEEEIIIYQQQrxw/gdMkJG4QDD50wAAAABJRU5ErkJggg\u003d\u003d"
  },
  "description": "AdTiming Tag helps you install AdTiming\u0027s event tracking tag on your website via Google Tag Manager and report specified event data.",
  "categories": [
    "MARKETING",
    "CONVERSION_TRACKING",
    "ADVERTISING"
  ],
  "containerContexts": [
    "WEB"
  ]
}


___TEMPLATE_PARAMETERS___

[
  {
    "type": "TEXT",
    "name": "accountId",
    "displayName": "AdTiming Account ID",
    "simpleValueType": true,
    "help": "Please contact your Account Manager for details."
  },
  {
    "type": "CHECKBOX",
    "name": "enhancedEcomm",
    "checkboxText": "Use Enhanced Ecommerce",
    "simpleValueType": true,
    "help": "Select this option if you have a Google Enhance Ecommerce data layer installed on your site. When this option is selected, the required parameters will be collected from the data layer."
  },
  {
    "type": "SELECT",
    "name": "eventType",
    "displayName": "Event Type",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "add_to_cart",
        "displayValue": "Add To Cart"
      },
      {
        "value": "view_item",
        "displayValue": "View Item"
      },
      {
        "value": "view_cart",
        "displayValue": "View Cart"
      },
      {
        "value": "purchase",
        "displayValue": "Purchase"
      }
    ],
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "enhancedEcomm",
        "paramValue": false,
        "type": "EQUALS"
      }
    ]
  },
  {
    "type": "SELECT",
    "name": "eventType_enhanced",
    "displayName": "Event Type",
    "macrosInSelect": false,
    "selectItems": [
      {
        "value": "ADD_TO_CART",
        "displayValue": "Add To Cart"
      },
      {
        "value": "PURCHASE",
        "displayValue": "Purchase"
      },
      {
        "value": "PRODUCT_VIEW",
        "displayValue": "Product View"
      },
      {
        "value": "REMOVE_FROM_CART",
        "displayValue": "Remove From Cart"
      },
      {
        "value": "CHECKOUT",
        "displayValue": "Checkout"
      }
    ],
    "simpleValueType": true,
    "enablingConditions": [
      {
        "paramName": "enhancedEcomm",
        "paramValue": true,
        "type": "EQUALS"
      }
    ]
  }
]


___SANDBOXED_JS_FOR_WEB_TEMPLATE___

// Require necessary APIs
const log = require("logToConsole");
const injectScript = require("injectScript");
const encodeUriComponent = require("encodeUriComponent");
const copyFromDataLayer = require("copyFromDataLayer");
const getType = require("getType");
const copyFromWindow = require("copyFromWindow");
let _AdtRtTag = copyFromWindow("_AdtRtTag") || [];

const accountId = data.accountId;

// Build the payload for the _AdtRtTag call
const params = {};

const mapEnProducts = (products) => {
  return products.map((i) => {
    return {
      pid: i.id,
      q: i.quantity,
      p: i.price,
      a: 1,
    };
  });
};

const mapProducts = (products) => {
  return products.map((i) => {
    return {
      pid: i.id,
      q: i.quantity,
      p: i.price,
      a: 1,
    };
  });
};

log("event enhancedEcomm :" + data.enhancedEcomm);

if (data.enhancedEcomm) {
  const ecomm = copyFromDataLayer("ecommerce") || {};
  log("enhancedevent:",data.eventType_enhanced);
  if (
    data.eventType_enhanced === "PRODUCT_VIEW" &&
    ecomm.hasOwnProperty("detail") &&
    getType(ecomm.detail.products) === "array"
  ) {
    params.items = mapEnProducts(ecomm.add.products);
    params.e = "4";
  }
  if (
    data.eventType_enhanced === "ADD_TO_CART" &&
    ecomm.hasOwnProperty("add") &&
    getType(ecomm.add.products) === "array"
  ) {
    params.items = mapEnProducts(ecomm.add.products);
    params.e = "5";
  }
  if (
    data.eventType_enhanced === "PURCHASE" &&
    ecomm.hasOwnProperty("purchase")
  ) {
    params.items = mapEnProducts(ecomm.purchase.products);
    params.tranId = ecomm.purchase.actionField.id;
    params.e = "8";
  }
  if (
    data.eventType_enhanced === "REMOVE_FROM_CART" &&
    ecomm.hasOwnProperty("remove") &&
    getType(ecomm.remove.products) === "array"
  ) {
    params.items = mapEnProducts(ecomm.remove.products);
    params.e = "10";
  }
  if (
    data.eventType_enhanced === "CHECKOUT" &&
    ecomm.hasOwnProperty("checkout")
  ) {
    if (!ecomm.checkout.products) {
      return; // when the checkout step doesn't have products data
    }
    params.items = mapProducts(ecomm.checkout.products);
    params.e = "10";
  }
  log("enhancedevent params eid" + params.e);
} else {
  const event = copyFromDataLayer("event") || {};
  log("enhancedevent:" + event);

  const eventModel = copyFromDataLayer("eventModel") || {};

  log("eventModel:" + eventModel);

  if (
    data.eventType === "view_item" &&
    event === "view_item" &&
    eventModel.hasOwnProperty("items")
  ) {
    params.items = mapProducts(eventModel.items);
    params.e = "4";
  }

  if (
    data.eventType === "add_to_cart" &&
    event === "add_to_cart" &&
    eventModel.hasOwnProperty("items")
  ) {
    params.items = mapProducts(eventModel.items);
    params.e = "5";
  }

  if (
    data.eventType === "view_cart" &&
    event === "view_cart" &&
    eventModel.hasOwnProperty("items")
  ) {
    params.items = mapProducts(eventModel.items);
    params.e = "6";
  }

  if (
    data.eventType === "purchase" &&
    event === "purchase" &&
    eventModel.hasOwnProperty("items")
  ) {
    params.items = mapProducts(eventModel.items);
    params.tranId = eventModel.transaction_id;
    params.e = "8";
  }

  log("event params eid" + params.e);
}



if (params) {
  _AdtRtTag.push(params);
}

// Load the AdtRtTag script if not already loaded
injectScript(
  "https://rt.adtiming.com/js/ld.js?a=" + encodeUriComponent(accountId),
  data.gtmOnSuccess,
  data.gtmOnFailure,
  "_adt_rt_script"
);


___WEB_PERMISSIONS___

[
  {
    "instance": {
      "key": {
        "publicId": "access_globals",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keys",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 3,
                "mapKey": [
                  {
                    "type": 1,
                    "string": "key"
                  },
                  {
                    "type": 1,
                    "string": "read"
                  },
                  {
                    "type": 1,
                    "string": "write"
                  },
                  {
                    "type": 1,
                    "string": "execute"
                  }
                ],
                "mapValue": [
                  {
                    "type": 1,
                    "string": "_AdtRtTag"
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": true
                  },
                  {
                    "type": 8,
                    "boolean": false
                  }
                ]
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "inject_script",
        "versionId": "1"
      },
      "param": [
        {
          "key": "urls",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "https://rt.adtiming.com/js/ld.js*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "logging",
        "versionId": "1"
      },
      "param": [
        {
          "key": "environments",
          "value": {
            "type": 1,
            "string": "debug"
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  },
  {
    "instance": {
      "key": {
        "publicId": "read_data_layer",
        "versionId": "1"
      },
      "param": [
        {
          "key": "keyPatterns",
          "value": {
            "type": 2,
            "listItem": [
              {
                "type": 1,
                "string": "ecommerce.*"
              },
              {
                "type": 1,
                "string": "eventModel.*"
              },
              {
                "type": 1,
                "string": "event.*"
              }
            ]
          }
        }
      ]
    },
    "clientAnnotations": {
      "isEditedByUser": true
    },
    "isRequired": true
  }
]


___TESTS___

scenarios:
- name: enhanced add to cart
  code: "const mockData = {\n  enhancedEcomm: true,\n  eventType_enhanced: 'ADD_TO_CART',\n\
    \  accountId: '1'\n};\n\nconst dataLayer = {\n      add: {\n         actionField:\
    \ {\n          list: 'Shopping cart'\n          },\n         products: [{ \n \
    \           name: 'item', \n            id: 'A123', \n            price:\
    \ 999,\n            quantity: 5\n        },\n        { \n            name: '\
    \ item2', \n            id: 'B123', \n            price: 999,\n            quantity:\
    \ 5\n        }]\n       } \n  };\nmock('copyFromDataLayer', (key) => {\n  return\
    \ dataLayer;\n});\n\nconst expected_params = {\n  notify: 'ecevent',\n  id: '1',\n\
    \  name: 'ADD_TO_CART',\n  productIds: ['A123', 'B123']\n};\nmock('createQueue',\
    \ (name) => {\n  assertThat(name).isEqualTo('_AdtRtTag');\n  return function(item)\
    \ {\n    assertThat(item).isEqualTo(expected_params);\n  };\n});\n\n// Call runCode\
    \ to run the template's code.\nrunCode(mockData);\n\n// Verify that the tag finished\
    \ successfully.\nassertApi('injectScript').wasCalled();"
